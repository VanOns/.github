name: Development deployment

on:
  workflow_dispatch:

env:
  PHP_VERSION: 8.5
  APP_NAMESPACE: ${{ secrets.DEV_APP_NAME }}
  REMOTE_BASE_PATH: /data/projects/${{ secrets.DEV_APP_NAME }}/
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“„ Clone repository
        uses: actions/checkout@v3

      - name: ğŸ”‘ Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEV_KEY }}

      - name: ğŸ§Š Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: ğŸ¤“ Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.DEV_KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: ğŸ›¡ï¸ Set up WireGuard
        uses: egor-tensin/setup-wireguard@v1
        with:
          endpoint: '${{ secrets.DEV_WG_ENDPOINT }}'
          endpoint_public_key: '${{ secrets.DEV_WG_ENDPOINT_PUBLIC_KEY }}'
          ips: '${{ secrets.DEV_WG_IPS }}'
          allowed_ips: '${{ secrets.DEV_WG_ALLOWED_IPS }}'
          private_key: '${{ secrets.DEV_WG_PRIVATE_KEY }}'
          preshared_key: '${{ secrets.DEV_WG_PRESHARED_KEY }}'

      - name: âš™ï¸ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: âš™ï¸ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: ğŸ”‘ Configure Composer authentication
        run: |
          composer config github-oauth.github.com ${{ secrets.TOKEN_GITHUB }}

      - name: âœ¨ Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Set up Composer dependency caching
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: â¬‡ï¸ Install Composer dependencies
        run: composer validate --no-check-publish && composer install --prefer-dist --no-progress --no-dev --no-ansi --no-interaction --optimize-autoloader

      - name: â¬‡ï¸ Install npm dependencies
        run: npm ci

      - name: ğŸ”§ Build npm
        run: npm run build

      - name: ğŸ“‚ Deploy
        run: rsync -avz --delete --include-from=.rsync . ${{ secrets.DEV_USER_NAME }}@${{ secrets.DEV_STORAGE_HOST }}:${{ env.REMOTE_BASE_PATH }}

      - name: ğŸ“‚ Create folders
        run: |
          ssh ${{ secrets.DEV_USER_NAME }}@${{ secrets.DEV_STORAGE_HOST }} << EOF
            cd ${{ env.REMOTE_BASE_PATH }}
            mkdir -p ${{ env.REMOTE_BASE_PATH }}storage/app
            mkdir -p ${{ env.REMOTE_BASE_PATH }}storage/logs
            mkdir -p ${{ env.REMOTE_BASE_PATH }}storage/framework/cache
            mkdir -p ${{ env.REMOTE_BASE_PATH }}storage/framework/logs
            mkdir -p ${{ env.REMOTE_BASE_PATH }}storage/framework/sessions
            mkdir -p ${{ env.REMOTE_BASE_PATH }}storage/framework/testing
            mkdir -p ${{ env.REMOTE_BASE_PATH }}storage/framework/views
          EOF

      - name: ğŸ”ï¸ Restart deployment
        run: |
          kubectl rollout restart deployment -n ${{ env.APP_NAMESPACE }}
